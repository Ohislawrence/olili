import{g as p,O as H,p as K,m as Q,N as R,c as D,w as A,a as e,b as v,i as x,q as J,e as L,f as l,h as y,o as r,F,k as O,t as h,s as W,j as I,y as N,n as _,A as U,C as Y,x as X,L as Z,z as ee}from"./app-BC2Zysz2.js";import{S as te}from"./StudentLayout-D3lut-kG.js";import{r as se}from"./PlusIcon-D2Wo47B2.js";import{r as oe}from"./ArrowPathIcon-q3wriwIF.js";import{r as ae}from"./XMarkIcon-DdqWzguO.js";import{r as re}from"./ChatBubbleLeftRightIcon-BD5MS_Pw.js";import{r as ne}from"./ExclamationTriangleIcon-DbbYtfcT.js";import{r as le}from"./PaperAirplaneIcon-_mbiumOK.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./CheckCircleIcon-DSxjnK3O.js";import"./SparklesIcon-B0REuVgH.js";import"./QuestionMarkCircleIcon-D-g_416Y.js";import"./UserIcon-BaDx2YND.js";import"./BellIcon-C3ThQtaK.js";import"./CreditCardIcon-BNyJxoay.js";const ie={class:"min-h-screen bg-gradient-to-br from-slate-50 to-emerald-50"},de={class:"flex h-screen"},ce={class:"w-80 bg-white border-r border-gray-200 flex flex-col"},ue={class:"p-4 border-b border-gray-200"},me=["disabled"],ge=["value"],he={key:0,class:"text-xs text-emerald-600 mt-2 flex items-center"},fe={class:"flex-1 overflow-auto p-4"},pe={class:"space-y-2"},xe={class:"text-sm font-medium text-gray-900 truncate"},ve={class:"text-xs text-gray-500 mt-1"},ye={class:"p-4 border-t border-gray-200"},_e={class:"flex-1 flex flex-col"},be={class:"bg-white border-b border-gray-200 px-6 py-4"},we={class:"flex items-center justify-between"},ke={class:"text-xl font-bold text-gray-900"},Se={key:0,class:"text-sm text-gray-600 mt-1"},Ie={class:"flex space-x-2"},Ce=["disabled"],Me={key:0,class:"text-center py-12"},Te={class:"mx-auto h-16 w-16 bg-gradient-to-r from-emerald-500 to-teal-500 rounded-full flex items-center justify-center mb-4"},De={key:1,class:"text-center py-8"},Ae=["innerHTML"],Fe={key:0,class:"ml-2 text-amber-500"},Oe={key:2,class:"flex justify-start"},je={key:3,class:"flex justify-center"},$e={class:"bg-red-50 border border-red-200 rounded-xl px-4 py-3 max-w-md"},Le={class:"flex items-center"},Ne={class:"text-sm text-red-700"},Ue={class:"border-t border-gray-200 p-4 bg-white"},Pe={class:"flex-1 relative"},Ee=["onKeydown","disabled"],Ve={class:"absolute bottom-2 right-2"},Be=["disabled"],Ge={key:1,class:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"},qe={class:"ml-2"},ze={key:0,class:"text-xs text-red-500 mt-2"},He={key:1,class:"text-xs text-gray-500 mt-2"},lt={__name:"Show",props:{chat_session:Object,related_topics:Array},setup(b){const a=b,C=p(null),i=p(""),u=p(!1),M=p(!1),m=p(!1),w=p(!1),c=p(a.chat_session.course_outline_id||""),f=p(null),n=H([]),P=p([]);let T=null;n.push(...a.chat_session.messages),K(c,(t,s)=>{t!==s&&$()});const E=t=>t?t.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/`(.*?)`/g,'<code class="bg-gray-100 px-1 rounded text-xs">$1</code>').replace(/\n/g,"<br>"):"",V=t=>new Date(t).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}),B=t=>{const s=new Date(t),g=Math.abs(new Date-s),d=Math.floor(g/(1e3*60*60*24));return d===0?"Today":d===1?"Yesterday":d<7?`${d} days ago`:s.toLocaleDateString("en-US",{month:"short",day:"numeric"})},k=()=>{Z(()=>{C.value&&(C.value.scrollTop=C.value.scrollHeight)})},G=async()=>{if(!m.value){m.value=!0,f.value=null;try{const t=await axios.get(route("chat.messages",{chatSession:a.chat_session.id}));if(t.data.success)n.splice(0,n.length,...t.data.messages),k(),t.data.session&&(a.chat_session.course_outline_id=t.data.session.course_outline_id,a.chat_session.topic_context=t.data.session.topic_context,c.value=t.data.session.course_outline_id||"");else throw new Error(t.data.error||"Failed to load messages")}catch(t){console.error("Failed to load messages:",t),f.value=t.response?.data?.error||"Failed to load messages. Please try again."}finally{m.value=!1}}},j=async()=>{if(!i.value.trim()||u.value||i.value.length>1e3)return;const t=i.value.trim();i.value="",u.value=!0,M.value=!0,f.value=null;const s={id:Date.now(),sender_type:"user",message:t,created_at:new Date().toISOString(),is_related_to_topic:!0};n.push(s),k();try{const o=await axios.post(route("courses.chat.send-message",{course:a.chat_session.course_id,chatSession:a.chat_session.id}),{message:t});if(o.data.success){const g=n.findIndex(d=>d.id===s.id);g>-1&&n.splice(g,1),n.push(o.data.message),o.data.session&&(Object.assign(a.chat_session,o.data.session),c.value=a.chat_session.course_outline_id||"")}else throw new Error(o.data.message||"Failed to send message")}catch(o){console.error("Failed to send message:",o);const g=n.findIndex(S=>S.id===s.id);g>-1&&n.splice(g,1),f.value=o.response?.data?.message||"Failed to send message. Please try again.";const d={id:Date.now()+1,sender_type:"ai",message:"I'm sorry, I'm having trouble responding right now. Please try again in a moment.",created_at:new Date().toISOString(),is_related_to_topic:!0};n.push(d)}finally{u.value=!1,M.value=!1,k()}},$=async()=>{if(!w.value){w.value=!0,f.value=null;try{console.log("Updating context to:",c.value);const t=await axios.post(route("chat.update-context",a.chat_session.id),{outline_id:c.value||null});if(t.data.success){a.chat_session.course_outline_id=c.value,a.chat_session.topic_context=t.data.new_context?.topic_title||"General Questions";const s=c.value?a.related_topics.find(g=>g.id==c.value)?.title:"General Questions",o={id:Date.now(),sender_type:"ai",message:`ðŸŽ¯ <strong>Context Updated:</strong> I'm now focusing on <em>"${s}"</em>. Ask me anything specific about this topic!`,created_at:new Date().toISOString(),is_related_to_topic:!0,is_system:!0};n.push(o),k(),console.log("Context updated successfully")}else throw new Error(t.data.message||"Failed to update context")}catch(t){console.error("Context update failed:",t),f.value=t.response?.data?.message||"Failed to update context. Please try again.",c.value!==(a.chat_session.course_outline_id||"")&&(c.value=a.chat_session.course_outline_id||"")}finally{w.value=!1}}},q=async()=>{if(confirm("Are you sure you want to close this chat session?"))try{await axios.delete(route("chat.close",a.chat_session.id)),ee.visit(route("chat.index"))}catch(t){console.error("Failed to close session:",t),f.value="Failed to close session. Please try again."}},z=()=>{T=setInterval(async()=>{if(!(u.value||M.value||w.value))try{const t=await axios.get(route("chat.messages",{chatSession:a.chat_session.id}));if(t.data.success){const s=n.map(d=>d.id).sort(),o=t.data.messages.map(d=>d.id).sort();if(JSON.stringify(s)!==JSON.stringify(o)&&(n.splice(0,n.length,...t.data.messages),k()),t.data.session){const d=a.chat_session.course_outline_id||"",S=t.data.session.course_outline_id||"";d!==S&&(a.chat_session.course_outline_id=S,c.value=S)}}}catch(t){console.error("Failed to poll messages:",t)}},3e3)};return Q(()=>{k(),z()}),R(()=>{T&&clearInterval(T)}),(t,s)=>(r(),D(te,null,{default:A(()=>[e("div",ie,[v(x(J),{title:"AI Tutor Chat"}),e("div",de,[e("div",ce,[s[8]||(s[8]=e("div",{class:"p-4 border-b border-gray-200"},[e("h2",{class:"text-lg font-bold text-gray-900"},"AI Tutor"),e("p",{class:"text-sm text-gray-600 mt-1"}," Ask questions about your course ")],-1)),e("div",ue,[s[4]||(s[4]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"}," Course Context ",-1)),L(e("select",{"onUpdate:modelValue":s[0]||(s[0]=o=>c.value=o),onChange:$,class:"w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 shadow-sm",disabled:w.value},[s[2]||(s[2]=e("option",{value:""},"General Questions",-1)),(r(!0),l(F,null,O(b.related_topics,o=>(r(),l("option",{key:o.id,value:o.id},h(o.title),9,ge))),128))],40,me),[[W,c.value]]),w.value?(r(),l("div",he,[...s[3]||(s[3]=[e("div",{class:"animate-spin rounded-full h-3 w-3 border-b-2 border-emerald-600 mr-2"},null,-1),I(" Updating context... ",-1)])])):y("",!0),s[5]||(s[5]=e("p",{class:"text-xs text-gray-500 mt-2"}," Setting context helps the AI provide more relevant answers ",-1))]),e("div",fe,[s[6]||(s[6]=e("h3",{class:"text-sm font-medium text-gray-900 mb-3"}," Recent Chats ",-1)),e("div",pe,[(r(!0),l(F,null,O(P.value,o=>(r(),D(x(N),{key:o.id,href:t.route("student.chat.show",o.id),class:_(["block p-3 rounded-lg border border-gray-200 hover:border-emerald-300 hover:bg-emerald-50 transition-colors",{"border-emerald-300 bg-emerald-50":o.id===b.chat_session.id}])},{default:A(()=>[e("p",xe,h(o.topic_context||"General Chat"),1),e("p",ve,h(B(o.last_activity_at)),1)]),_:2},1032,["href","class"]))),128))])]),e("div",ye,[v(x(N),{href:t.route("student.chat.create"),class:"w-full flex items-center justify-center px-4 py-2.5 text-sm font-semibold text-white bg-gradient-to-r from-emerald-600 to-teal-600 rounded-lg hover:from-emerald-700 hover:to-teal-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 shadow-sm hover:shadow-md transition-all duration-200"},{default:A(()=>[v(x(se),{class:"h-4 w-4 mr-2"}),s[7]||(s[7]=I(" New Chat ",-1))]),_:1},8,["href"])])]),e("div",_e,[e("div",be,[e("div",we,[e("div",null,[e("h1",ke,h(b.chat_session.topic_context||"AI Tutor"),1),b.chat_session.course?(r(),l("p",Se,h(b.chat_session.course.title),1)):y("",!0)]),e("div",Ie,[e("button",{onClick:G,class:"inline-flex items-center px-3 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-emerald-500 shadow-sm hover:shadow-md transition-colors",disabled:m.value},[v(x(oe),{class:"h-4 w-4 mr-1"}),I(" "+h(m.value?"Refreshing...":"Refresh"),1)],8,Ce),e("button",{onClick:q,class:"inline-flex items-center px-3 py-2 border border-emerald-300 rounded-lg text-sm font-medium text-emerald-700 bg-white hover:bg-emerald-50 focus:outline-none focus:ring-2 focus:ring-emerald-500 shadow-sm hover:shadow-md transition-colors"},[v(x(ae),{class:"h-4 w-4 mr-1"}),s[9]||(s[9]=I(" End Chat ",-1))])])])]),e("div",{ref_key:"messagesContainer",ref:C,class:"flex-1 overflow-auto p-6 space-y-4"},[n.length===0&&!m.value?(r(),l("div",Me,[e("div",Te,[v(x(re),{class:"h-8 w-8 text-white"})]),s[10]||(s[10]=e("h3",{class:"text-lg font-semibold text-gray-900 mb-2"}," Welcome to AI Tutor! ",-1)),s[11]||(s[11]=e("p",{class:"text-sm text-gray-600 max-w-md mx-auto"}," Ask me anything about your course. I'm here to help you learn and understand the material better. ",-1))])):y("",!0),m.value?(r(),l("div",De,[...s[12]||(s[12]=[e("div",{class:"animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-600 mx-auto mb-4"},null,-1),e("p",{class:"text-sm text-gray-500"},"Loading messages...",-1)])])):y("",!0),(r(!0),l(F,null,O(n,o=>(r(),l("div",{key:o.id,class:_(["flex",{"justify-end":o.sender_type==="user","justify-start":o.sender_type!=="user"}])},[e("div",{class:_(["max-w-3/4 rounded-xl px-4 py-3 shadow-sm",{"bg-gradient-to-r from-emerald-600 to-teal-600 text-white":o.sender_type==="user","bg-white border border-gray-200":o.sender_type!=="user"}])},[e("div",{innerHTML:E(o.message)},null,8,Ae),e("p",{class:_(["text-xs mt-1",{"text-emerald-200":o.sender_type==="user","text-gray-500":o.sender_type!=="user"}])},[I(h(V(o.created_at))+" ",1),o.sender_type==="ai"&&!o.is_related_to_topic?(r(),l("span",Fe," (May be off-topic) ")):y("",!0)],2)],2)],2))),128)),M.value?(r(),l("div",Oe,[...s[13]||(s[13]=[e("div",{class:"bg-white border border-gray-200 rounded-xl px-4 py-3 shadow-sm"},[e("div",{class:"flex items-center space-x-2"},[e("div",{class:"flex space-x-1"},[e("div",{class:"w-2 h-2 bg-emerald-400 rounded-full animate-bounce",style:{"animation-delay":"0.1s"}}),e("div",{class:"w-2 h-2 bg-emerald-400 rounded-full animate-bounce",style:{"animation-delay":"0.2s"}}),e("div",{class:"w-2 h-2 bg-emerald-400 rounded-full animate-bounce",style:{"animation-delay":"0.3s"}})]),e("span",{class:"text-xs text-gray-500"},"Oli Tutor is typing...")])],-1)])])):y("",!0),f.value?(r(),l("div",je,[e("div",$e,[e("div",Le,[v(x(ne),{class:"h-4 w-4 text-red-500 mr-2"}),e("p",Ne,h(f.value),1)])])])):y("",!0)],512),e("div",Ue,[e("form",{onSubmit:U(j,["prevent"]),class:"flex space-x-4"},[e("div",Pe,[L(e("textarea",{"onUpdate:modelValue":s[1]||(s[1]=o=>i.value=o),onKeydown:Y(U(j,["exact","prevent"]),["enter"]),rows:"2",placeholder:"Ask a question about your course...",class:_(["w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 resize-none shadow-sm transition-colors",{"border-red-300":i.value.length>1e3,"hover:border-gray-400":!u.value&&!m.value}]),disabled:u.value||m.value},null,42,Ee),[[X,i.value]]),e("div",Ve,[e("span",{class:_(["text-xs",i.value.length>1e3?"text-red-500":"text-gray-400"])},h(i.value.length)+"/1000 ",3)])]),e("button",{type:"submit",disabled:!i.value.trim()||u.value||m.value||i.value.length>1e3,class:_(["self-end px-6 py-2.5 bg-gradient-to-r from-emerald-600 to-teal-600 text-white rounded-lg hover:from-emerald-700 hover:to-teal-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 shadow-sm hover:shadow-md flex items-center justify-center min-w-[100px]",{"hover:scale-105":!u.value&&i.value.trim()&&i.value.length<=1e3,"transform scale-95":u.value}])},[u.value?(r(),l("div",Ge)):(r(),D(x(le),{key:0,class:"h-4 w-4"})),e("span",qe,h(u.value?"Sending...":"Send"),1)],10,Be)],32),i.value.length>1e3?(r(),l("p",ze," Message too long. Please keep under 1000 characters. ")):(r(),l("p",He," Press Enter to send. The AI will focus on your current course context. "))])])])])]),_:1}))}};export{lt as default};
